问题：

1、rap是在网络层协议，直接被以太网协议进行封装，但是它为什么知道ip呢？应该只有mac地址吧

2、rap广播请求包是什么？

3、ip层对于udp层不是透明的吗？那么udp层如何知道ip的伪首部



[TOC]

### 一、ARP协议介绍

**1、协议介绍**

​	ARP协议的全程是address resolution protocol（地址解析协议），就是把ip地址转换为主机mac地址，为什么要做这样一件事呢？

​	我们使用的TCP/IP是分层协议，其中IP协议位于第二层，属于网络层协议，同时它使用IP地址来表示源主机和目的主机。但其实IP层不是真正负责数据传输的，ip地址本身也是一个逻辑地址，如果单单只有ip地址，是传输不了任何数据的。

​	真正负责网络数据传输的是最下面一层，网络链路层。大多数情况下，链路层的协议是以太网。以太网负责把多个机器连接到一起，组成局域网，并且局域网内每台主机通过唯一的主机mac地址进行区分。所以，数据在链路层传输的时候，需要把目的ip地址转化为目的的mac地址才能进行数据传输。

​	每个主机MAC地址都用6个字节，每个字节用：进行分隔开，例如我的主机地址是：	34:DE:1A:C5:B0:7F

**2、ARP缓存**

​	如果每次主机通讯都要发送ARP协议去查询MAC地址无疑是十分低效率的，所以操作系统会有一个ARP缓存的东西，就是把之前的ARP查询记录保存下来，那么下次如果还是发送数据给之前发送过的ip地址，就可以直接找到对应的MAC地址。这样能大大提高效率。

### 二、ARP首部

​	ARP报文格式如下图所示，非常简单，首部共20个字节。对于IP地址转换为MAC地址来说，ARP报文长度是28个字节。

![](./picture/10.jpg)

- `Hardware Type`：传输 ARP 报文的物理网络类型，最常见的是以太网类型，对应的值是 1。这个字段的长度是 2 字节
- `Protocol Type`：网络报文类型，字段长度是 2 字节。最常用的是 IPv4 报文，对应的值是 2048（十六进制为 0x0800，这和以太网帧中帧类型字段使用的 IP 报文类型相同，这是有意设计的）
- `Hardware Address Length`：物理地址长度，字段长度是 1 比特。ARP 协议报文中物理地址（MAC 地址）有多少比特，对于大部分网络来说，这个值是 6（因为 MAC 地址是 6 个字节，48 比特长）
- `Protocol Address Length`：网络地址长度，字段长度是 1 比特。表示 ARP 协议报文中网络地址（IP 地址）有多少比特，对于大部分网络来说，这个值是 4（因为 IPv4 地址是 4 个字节，32 比特）
- `Opcode`：ARP 报文的类型，接下来我们会看到几种不同的 ARP 报文。这个字段占用 2 个比特，**值为 1 代表 ARP 请求报文，值为 2 代表 ARP 应答报文，3 代表 RARP 请求报文，4 代表 RARP 应答报文**
- `Sender Hardware Address`：当前 ARP 报文的发送方的物理地址（MAC 地址）
- `Send Protocol Address`：当前 ARP 报文发送发的网络地址（IPv4 地址）
- `Target Hardware Address`：当前 ARP 报文接收方的物理地址（MAC 地址），如果是 ARP 情况请，这个字段为空（因为发送方就是不知道对方的 MAC 地址从会使用 ARP 来解析）
- `Target Protocol Address`：当前 ARP 报文接收方的网络地址（IPv4 地址）

### 三、ARP工作流程

**1、两台主机在同一网段**

**第一步：**机器A想和同一个以太网络的机器B通信，A会在自己的ARP表中查找B的MAC地址，如果能找到就直接发送以太网帧；如果没有找到的话，就跳到第二步

**第二步：**机器A发送ARP请求报文去查询机器B的MAC地址，这是一个以太网广播报文，因此交换机会广播到网络中的所有机器。

**第三步：**各个主机收到ARP请求报文，如果发现报文中询问的ip地址与自己不同，则直接丢弃；如果机器人B发现ARP报文中询问的IP地址是自己的地址，那么就生成一个ARP应答报文，把自己的MAC地址填写到报文中，发给主机A。这个报文是单播报文，不会发给其他主机，同时机器B也会把A的ARP记录缓存起来。

**第四步：**机器A收到B发送过来的ARP应答，读取报文B中的MAC地址，使用这个地址和B进行后续通信，同时把它缓存在系统中。

**2、两台主机不在同一网段**

​	当主机A和主机B不在同一网段时，主机A就会先向网关发出ARP请求，ARP请求报文中的目标IP地址为网关的IP地址。当主机A从收到的响应报文中获得网关的MAC地址后，将报文封装并发给网关。如果网关没有主机B的ARP表项，网关会广播ARP请求，目标IP地址为主机B的IP地址，当网关从收到的响应报文中获得主机B的MAC地址后，就可以将报文发给主机B；如果网关已经有主机B的ARP表项，网关直接把报文发给主机B。